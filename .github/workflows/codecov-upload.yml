name: Upload coverage to Codecov

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  upload:
    runs-on: ubuntu-latest

    if: >
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main' &&
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Install tooling
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq unzip

      - name: Download and extract coverage artifact
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_NAME: coverage-report
        run: |
          set -euo pipefail

          echo "Fetching all artifacts..."
          artifacts=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/artifacts")

          artifact_id=$(echo "$artifacts" | jq -r \
            --arg name "$ARTIFACT_NAME" '
              .artifacts
              | sort_by(.created_at) | reverse
              | map(select(.name == $name))
              | .[0].id
            ')

          if [[ -z "$artifact_id" || "$artifact_id" == "null" ]]; then
            echo "Artifact '$ARTIFACT_NAME' not found!"
            exit 1
          fi

          echo "Found artifact ID: $artifact_id"

          curl -sL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/artifacts/${artifact_id}/zip" \
            -o artifact.zip

          unzip -o artifact.zip

      - name: Debug extracted files
        run: |
          echo "Directory tree after extraction:"
          ls -R .

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: >
            coverage-report/users-service/coverage.xml,
            coverage-report/products-service/coverage.xml,
            coverage-report/orders-service/coverage.xml
          fail_ci_if_error: true
