name: Upload coverage to Codecov

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:
  upload:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main' &&
      github.event.workflow_run.conclusion == 'success'

    steps:
    - name: Download coverage artifact from CI run (REST API)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RUN_ID: ${{ github.event.workflow_run.check_suite_id }}
      run: |
        set -euo pipefail

        # install small deps
        sudo apt-get update -y
        sudo apt-get install -y jq unzip

        run_id="${RUN_ID}"
        repo_full="${GITHUB_REPOSITORY}"
        owner="${repo_full%%/*}"
        repo="${repo_full##*/}"
        artifact_name="coverage-report"

        echo "Looking for artifact '${artifact_name}' in run ${run_id} of ${owner}/${repo}..."
        artifacts_url="https://api.github.com/repos/${owner}/${repo}/actions/runs/${run_id}/artifacts"

        artifact_id=$(curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" "${artifacts_url}" \
          | jq -r '.artifacts[] | select(.name==env.artifact_name) | .id' --arg artifact_name "${artifact_name}")

        if [ -z "${artifact_id}" ] || [ "${artifact_id}" = "null" ]; then
          echo "Artifact '${artifact_name}' not found for run ${run_id}"
          echo "Available artifacts:"
          curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" "${artifacts_url}" | jq -r '.artifacts[] | "\(.name) (id:\(.id))"'
          exit 1
        fi

        echo "Found artifact id: ${artifact_id}. Downloading..."
        download_url="https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${artifact_id}/zip"
        curl -sL -H "Authorization: Bearer ${GITHUB_TOKEN}" "${download_url}" -o coverage-artifact.zip

        mkdir -p coverage
        unzip -o coverage-artifact.zip -d coverage
        echo "Artifact extracted to ./coverage"

    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Upload to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: |
          coverage/users-service/coverage.xml
          coverage/products-service/coverage.xml
          coverage/orders-service/coverage.xml
        token: ${{ secrets.CODECOV_TOKEN }}
