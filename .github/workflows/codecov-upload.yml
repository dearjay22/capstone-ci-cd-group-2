name: Upload coverage to Codecov

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  upload:
    runs-on: ubuntu-latest

    # Only run when CI succeeded AND it was triggered by a push to main
    if: >
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main' &&
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Install tooling
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq unzip

      - name: Download and extract artifact
        run: |
          set -euo pipefail
          curl -sL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/artifacts/${artifact_id}/zip" \
            -o artifact.zip

          unzip -o artifact.zip

      - name: Debug extracted files
        run: ls -R .

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: .
          fail_ci_if_error: true
